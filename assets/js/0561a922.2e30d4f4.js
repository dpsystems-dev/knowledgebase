"use strict";(globalThis.webpackChunkabm_web_portal_docs=globalThis.webpackChunkabm_web_portal_docs||[]).push([[8623],{9325(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>a,frontMatter:()=>d,metadata:()=>t,toc:()=>h});const t=JSON.parse('{"id":"stripe-integration/technical-support-guide","title":"Technical Support Guide","description":"Technical documentation for support staff covering the database structure, payment statuses, workflow, and troubleshooting.","source":"@site/docs/stripe-integration/technical-support-guide.md","sourceDirName":"stripe-integration","slug":"/stripe-integration/technical-support-guide","permalink":"/knowledgebase/stripe-integration/technical-support-guide","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"title":"Technical Support Guide","description":"Technical documentation for support staff covering the database structure, payment statuses, workflow, and troubleshooting."},"sidebar":"docsSidebar","previous":{"title":"Production Checklist","permalink":"/knowledgebase/stripe-integration/production-checklist"}}');var r=n(4848),i=n(8453);const d={sidebar_position:5,title:"Technical Support Guide",description:"Technical documentation for support staff covering the database structure, payment statuses, workflow, and troubleshooting."},c="Stripe Payment Integration - Technical Support Guide",l={},h=[{value:"Table of Contents",id:"table-of-contents",level:2},{value:"1. System Overview",id:"1-system-overview",level:2},{value:"2. The StripePayments Table",id:"2-the-stripepayments-table",level:2},{value:"Column Reference",id:"column-reference",level:3},{value:"Understanding AmountInCents",id:"understanding-amountincents",level:3},{value:"Key Relationships",id:"key-relationships",level:3},{value:"Understanding Custom Routines Status",id:"understanding-custom-routines-status",level:3},{value:"3. Payment Status Lifecycle",id:"3-payment-status-lifecycle",level:2},{value:"Status Definitions",id:"status-definitions",level:3},{value:"Status Transition Diagram",id:"status-transition-diagram",level:3},{value:"Valid Status Transitions",id:"valid-status-transitions",level:3},{value:"4. Payment Workflow Diagram",id:"4-payment-workflow-diagram",level:2},{value:"Complete Payment Flow",id:"complete-payment-flow",level:3},{value:"Four Ways Status Gets Updated",id:"four-ways-status-gets-updated",level:3},{value:"5. What Gets Updated and When",id:"5-what-gets-updated-and-when",level:2},{value:"Phase 1: Payment Creation",id:"phase-1-payment-creation",level:3},{value:"Phase 2: Session Created",id:"phase-2-session-created",level:3},{value:"Phase 3: Payment Completed",id:"phase-3-payment-completed",level:3},{value:"Phase 4: Payment Failed/Expired/Cancelled",id:"phase-4-payment-failedexpiredcancelled",level:3},{value:"Phase 5: Custom Routines (if enabled)",id:"phase-5-custom-routines-if-enabled",level:3},{value:"6. The Happy Path",id:"6-the-happy-path",level:2},{value:"Timeline Example",id:"timeline-example",level:3},{value:"Verifying a Successful Payment",id:"verifying-a-successful-payment",level:3},{value:"Custom Routines Verification (if enabled)",id:"custom-routines-verification-if-enabled",level:3},{value:"7. Custom Routines Processing",id:"7-custom-routines-processing",level:2},{value:"Overview",id:"overview",level:3},{value:"Status Flow",id:"status-flow",level:3},{value:"Key Support Notes",id:"key-support-notes",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3},{value:"8. ABM vs External User Flows",id:"8-abm-vs-external-user-flows",level:2},{value:"Overview",id:"overview-1",level:3},{value:"Why Different Success URLs?",id:"why-different-success-urls",level:3},{value:"Identifying Payment Source",id:"identifying-payment-source",level:3},{value:"Support Scenarios",id:"support-scenarios",level:3},{value:"9. Edge Cases and How the System Handles Them",id:"9-edge-cases-and-how-the-system-handles-them",level:2},{value:"Edge Case 1: Customer&#39;s Browser Crashes During Payment",id:"edge-case-1-customers-browser-crashes-during-payment",level:3},{value:"Edge Case 2: Webhook Fails to Arrive",id:"edge-case-2-webhook-fails-to-arrive",level:3},{value:"Edge Case 3: Customer Abandons Checkout",id:"edge-case-3-customer-abandons-checkout",level:3},{value:"Edge Case 3b: Customer Clicks &quot;Cancel&quot; on Stripe Checkout",id:"edge-case-3b-customer-clicks-cancel-on-stripe-checkout",level:3},{value:"Edge Case 4: Card Declined",id:"edge-case-4-card-declined",level:3},{value:"Edge Case 5: Network Retry Creates Duplicate Request",id:"edge-case-5-network-retry-creates-duplicate-request",level:3},{value:"Edge Case 6: Payment Stuck in CREATED Status",id:"edge-case-6-payment-stuck-in-created-status",level:3},{value:"Edge Case 7: Amount Validation Failures",id:"edge-case-7-amount-validation-failures",level:3},{value:"10. Troubleshooting Guide",id:"10-troubleshooting-guide",level:2},{value:"Problem: Payment Shows PENDING But Customer Says They Paid",id:"problem-payment-shows-pending-but-customer-says-they-paid",level:3},{value:"Problem: Payment Failed But No FailureReason",id:"problem-payment-failed-but-no-failurereason",level:3},{value:"Problem: Customer Can&#39;t Find Their Receipt",id:"problem-customer-cant-find-their-receipt",level:3},{value:"Problem: Duplicate Payments in Database",id:"problem-duplicate-payments-in-database",level:3},{value:"Problem: Payment Shows Amount Doesn&#39;t Match What Customer Paid",id:"problem-payment-shows-amount-doesnt-match-what-customer-paid",level:3},{value:"11. Quick Reference",id:"11-quick-reference",level:2},{value:"Status at a Glance",id:"status-at-a-glance",level:3},{value:"Key Columns for Troubleshooting",id:"key-columns-for-troubleshooting",level:3},{value:"Custom Routines Status at a Glance",id:"custom-routines-status-at-a-glance",level:3},{value:"ID Prefixes",id:"id-prefixes",level:3},{value:"Important Timeframes",id:"important-timeframes",level:3},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"stripe-payment-integration---technical-support-guide",children:"Stripe Payment Integration - Technical Support Guide"})}),"\n",(0,r.jsx)(s.p,{children:"This guide is for the support team to understand the technical aspects of the Stripe payment system. It covers the database structure, payment statuses, workflow, and troubleshooting."}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"table-of-contents",children:"Table of Contents"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#1-system-overview",children:"System Overview"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#2-the-stripepayments-table",children:"The StripePayments Table"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#3-payment-status-lifecycle",children:"Payment Status Lifecycle"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#4-payment-workflow-diagram",children:"Payment Workflow Diagram"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#5-what-gets-updated-and-when",children:"What Gets Updated and When"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#6-the-happy-path",children:"The Happy Path"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#7-custom-routines-processing",children:"Custom Routines Processing"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#8-abm-vs-external-user-flows",children:"ABM vs External User Flows"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#9-edge-cases-and-how-the-system-handles-them",children:"Edge Cases and How the System Handles Them"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#10-troubleshooting-guide",children:"Troubleshooting Guide"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.a,{href:"#11-quick-reference",children:"Quick Reference"})}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"1-system-overview",children:"1. System Overview"}),"\n",(0,r.jsx)(s.p,{children:"The Stripe payment system allows customers to pay via credit/debit card. There are three main components working together:"}),"\n",(0,r.jsx)(s.mermaid,{value:'flowchart TB\n    subgraph OurSystem["Our System"]\n        A[ABM Portal]\n        B[(StripePayments Table)]\n    end\n    subgraph External["External Services"]\n        C[Stripe Payment Processor]\n        D[Stripe Events / Webhooks]\n        E[Customer\'s Bank]\n    end\n\n    A <--\x3e|API calls| C\n    C <--\x3e|Card processing| E\n    A --\x3e|Store payment data| B\n    D --\x3e|Notifications| A'}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"How payments flow:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"User creates a payment request in ABM Portal"}),"\n",(0,r.jsx)(s.li,{children:"Portal creates a Stripe checkout session"}),"\n",(0,r.jsx)(s.li,{children:"Customer is redirected to Stripe's secure payment page"}),"\n",(0,r.jsx)(s.li,{children:"Customer enters card details and pays"}),"\n",(0,r.jsx)(s.li,{children:"Stripe notifies our system (via webhook) when payment completes"}),"\n",(0,r.jsx)(s.li,{children:"Portal updates the StripePayments table"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"2-the-stripepayments-table",children:"2. The StripePayments Table"}),"\n",(0,r.jsx)(s.p,{children:"This is the main table that stores all payment information. Understanding each column is essential for troubleshooting."}),"\n",(0,r.jsx)(s.h3,{id:"column-reference",children:"Column Reference"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Example Value"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"PaymentId"})}),(0,r.jsx)(s.td,{children:"Unique internal ID (auto-generated)"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"1"}),", ",(0,r.jsx)(s.code,{children:"2"}),", ",(0,r.jsx)(s.code,{children:"3"}),"..."]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"IdempotencyKey"})}),(0,r.jsx)(s.td,{children:"Prevents duplicate payments on retry"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pay_abc123_1704795600000"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CustomerUniqueId"})}),(0,r.jsx)(s.td,{children:"Links to the Customers table"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"CUST001"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CustomerCode"})}),(0,r.jsx)(s.td,{children:"Customer's short code for reference"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"000001"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"StripeSessionId"})}),(0,r.jsx)(s.td,{children:"Stripe's checkout session ID"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"cs_test_a1b2c3..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"StripePaymentIntentId"})}),(0,r.jsx)(s.td,{children:"Stripe's payment intent ID"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pi_3abc123..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"StripeSessionUrl"})}),(0,r.jsx)(s.td,{children:"The checkout URL the customer visited"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"https://checkout.stripe.com/..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"AmountInCents"})}),(0,r.jsx)(s.td,{children:"Payment amount in smallest currency unit"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"2550"})," (= EUR 25.50)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Currency"})}),(0,r.jsx)(s.td,{children:"3-letter currency code"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"EUR"}),", ",(0,r.jsx)(s.code,{children:"USD"}),", ",(0,r.jsx)(s.code,{children:"GBP"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"ReferenceText"})}),(0,r.jsx)(s.td,{children:"User-entered reference (invoice number)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"Invoice #2024-001"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Status"})}),(0,r.jsx)(s.td,{children:"Current payment status"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"created"}),", ",(0,r.jsx)(s.code,{children:"pending"}),", ",(0,r.jsx)(s.code,{children:"completed"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CreatedAt"})}),(0,r.jsx)(s.td,{children:"When payment was initiated"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2025-01-09 10:30:00"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"UpdatedAt"})}),(0,r.jsx)(s.td,{children:"Last status change time"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2025-01-09 10:35:00"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CompletedAt"})}),(0,r.jsx)(s.td,{children:"When payment succeeded (if applicable)"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2025-01-09 10:35:00"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"ExpiresAt"})}),(0,r.jsx)(s.td,{children:"When the checkout session expires"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2025-01-10 10:30:00"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CreatedByEmail"})}),(0,r.jsx)(s.td,{children:"Email of user who initiated payment"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"john@abm.com"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"SourceRole"})}),(0,r.jsxs)(s.td,{children:["Who initiated: ",(0,r.jsx)(s.code,{children:"abm"})," or ",(0,r.jsx)(s.code,{children:"external"})]}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"abm"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"StripeEventId"})}),(0,r.jsx)(s.td,{children:"ID of Stripe webhook event that updated status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"evt_abc123..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"StripeReceiptUrl"})}),(0,r.jsx)(s.td,{children:"Link to downloadable receipt"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"https://receipts.stripe.com/..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"FailureReason"})}),(0,r.jsx)(s.td,{children:"Error message if payment failed"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"Card was declined"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"LatestStatusUpdateSource"})}),(0,r.jsx)(s.td,{children:"What triggered the last update"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"webhook"}),", ",(0,r.jsx)(s.code,{children:"polling"}),", ",(0,r.jsx)(s.code,{children:"public_polling"}),", ",(0,r.jsx)(s.code,{children:"cron"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CustomRoutinesStatus"})}),(0,r.jsx)(s.td,{children:"Post-payment processing status"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"skip"}),", ",(0,r.jsx)(s.code,{children:"pending"}),", ",(0,r.jsx)(s.code,{children:"completed"}),", ",(0,r.jsx)(s.code,{children:"error"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CustomRoutinesProcessedAt"})}),(0,r.jsx)(s.td,{children:"When custom routines finished"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2025-01-09 10:35:30"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CustomRoutinesError"})}),(0,r.jsx)(s.td,{children:"Error message if failed"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"Procedure failed: ..."})})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"understanding-amountincents",children:"Understanding AmountInCents"}),"\n",(0,r.jsxs)(s.p,{children:["The amount is always stored in the ",(0,r.jsx)(s.strong,{children:"smallest currency unit"})," (cents/pence):"]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Currency"}),(0,r.jsx)(s.th,{children:"Amount Shown"}),(0,r.jsx)(s.th,{children:"AmountInCents"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"EUR 25.50"}),(0,r.jsx)(s.td,{children:"Twenty-five euros fifty cents"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"2550"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"USD 100.00"}),(0,r.jsx)(s.td,{children:"One hundred dollars"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"10000"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"GBP 10.99"}),(0,r.jsx)(s.td,{children:"Ten pounds ninety-nine pence"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"1099"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"JPY 1000"}),(0,r.jsx)(s.td,{children:"One thousand yen"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"1000"})," (no conversion*)"]})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"*Japanese Yen and some other currencies have no decimal places."}),"\n",(0,r.jsx)(s.h3,{id:"key-relationships",children:"Key Relationships"}),"\n",(0,r.jsx)(s.mermaid,{value:'erDiagram\n    StripePayments ||--o| Customers : "links to"\n    StripePayments {\n        int PaymentId PK\n        string CustomerUniqueId FK\n        string CustomerCode\n        string Status\n        int AmountInCents\n        string Currency\n    }\n    Customers {\n        string UniqueId PK\n        string CustomerCode\n        string CustomerTitle\n        int CurrencyCode\n    }'}),"\n",(0,r.jsx)(s.h3,{id:"understanding-custom-routines-status",children:"Understanding Custom Routines Status"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Status"}),(0,r.jsx)(s.th,{children:"Meaning"}),(0,r.jsx)(s.th,{children:"Action Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"skip"})}),(0,r.jsx)(s.td,{children:"Feature disabled when payment completed"}),(0,r.jsx)(s.td,{children:"None"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pending"})}),(0,r.jsx)(s.td,{children:"Waiting for processor"}),(0,r.jsx)(s.td,{children:"Wait"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"completed"})}),(0,r.jsx)(s.td,{children:"All procedures succeeded"}),(0,r.jsx)(s.td,{children:"None"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"error"})}),(0,r.jsx)(s.td,{children:"Procedure failed"}),(0,r.jsx)(s.td,{children:"Check CustomRoutinesError"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Note:"})," Custom routines don't retry. Error status means post-payment processing failed, but payment itself is still ",(0,r.jsx)(s.code,{children:"completed"}),"."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"3-payment-status-lifecycle",children:"3. Payment Status Lifecycle"}),"\n",(0,r.jsx)(s.h3,{id:"status-definitions",children:"Status Definitions"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Status"}),(0,r.jsx)(s.th,{children:"UI Color"}),(0,r.jsx)(s.th,{children:"Meaning"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CREATED"})}),(0,r.jsx)(s.td,{children:"Blue"}),(0,r.jsx)(s.td,{children:"Payment request initiated, checkout session being set up"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"PENDING"})}),(0,r.jsx)(s.td,{children:"Yellow"}),(0,r.jsx)(s.td,{children:"Customer redirected to Stripe, waiting for payment"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"COMPLETED"})}),(0,r.jsx)(s.td,{children:"Green"}),(0,r.jsx)(s.td,{children:"Payment successful, money received"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"FAILED"})}),(0,r.jsx)(s.td,{children:"Red"}),(0,r.jsx)(s.td,{children:"Card declined or payment error"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"CANCELLED"})}),(0,r.jsx)(s.td,{children:"Red"}),(0,r.jsx)(s.td,{children:"User cancelled via the authenticated result page (external flow)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"EXPIRED"})}),(0,r.jsx)(s.td,{children:"Grey"}),(0,r.jsx)(s.td,{children:"Customer didn't complete payment within 24 hours"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"status-transition-diagram",children:"Status Transition Diagram"}),"\n",(0,r.jsx)(s.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e CREATED: Initial state\n\n    CREATED --\x3e PENDING: Session created\n    CREATED --\x3e EXPIRED: Session stuck\n    CREATED --\x3e CANCELLED: User cancels\n\n    PENDING --\x3e COMPLETED: Payment succeeds\n    PENDING --\x3e FAILED: Card declined\n    PENDING --\x3e EXPIRED: 24h timeout\n    PENDING --\x3e CANCELLED: User cancels\n\n    COMPLETED --\x3e [*]: Terminal State\n    FAILED --\x3e [*]: Terminal State\n    EXPIRED --\x3e [*]: Terminal State\n    CANCELLED --\x3e [*]: Terminal State"}),"\n",(0,r.jsx)(s.h3,{id:"valid-status-transitions",children:"Valid Status Transitions"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"From Status"}),(0,r.jsx)(s.th,{children:"Can Change To"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CREATED"}),(0,r.jsx)(s.td,{children:"PENDING, EXPIRED, CANCELLED"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"PENDING"}),(0,r.jsx)(s.td,{children:"COMPLETED, FAILED, EXPIRED, CANCELLED"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"COMPLETED"}),(0,r.jsx)(s.td,{children:"Nothing (final state)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"FAILED"}),(0,r.jsx)(s.td,{children:"Nothing (final state)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"EXPIRED"}),(0,r.jsx)(s.td,{children:"Nothing (final state)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CANCELLED"}),(0,r.jsx)(s.td,{children:"Nothing (final state)"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Important:"}),' Once a payment reaches COMPLETED, FAILED, EXPIRED, or CANCELLED, it cannot change to any other status. These are called "terminal states."']}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"4-payment-workflow-diagram",children:"4. Payment Workflow Diagram"}),"\n",(0,r.jsx)(s.h3,{id:"complete-payment-flow",children:"Complete Payment Flow"}),"\n",(0,r.jsx)(s.mermaid,{value:'sequenceDiagram\n    participant Portal as ABM Portal\n    participant Server as Our Server\n    participant Stripe\n    participant DB as StripePayments DB\n\n    rect rgb(240, 248, 255)\n        Note over Portal,DB: Payment Creation Phase\n        Portal->>Server: 1. Click "Request Payment"\n        Server->>DB: 2. Create payment record (Status: CREATED)\n        Server->>Stripe: 3. Create checkout session\n        Stripe--\x3e>Server: Session URL returned\n        Server->>DB: 4. Update record (Status: PENDING, store session URL)\n        Server--\x3e>Portal: 5. Return checkout URL\n    end\n\n    rect rgb(255, 248, 240)\n        Note over Portal,DB: Customer Checkout Phase\n        Portal->>Stripe: 6. Redirect customer to Stripe\n        Note over Stripe: Customer enters card details<br/>and clicks "Pay"\n        Stripe->>Stripe: Process payment\n    end\n\n    rect rgb(240, 255, 240)\n        Note over Portal,DB: Status Update Phase\n        alt Webhook (Primary)\n            Stripe->>Server: 7a. Send webhook event\n        else Polling (Backup)\n            Portal->>Server: 7b. Frontend checks status\n        else Cron (Fallback)\n            Server->>Stripe: 7c. Background job checks\n        end\n        Server->>DB: 8. Update status to COMPLETED\n        Server->>Stripe: 9. Fetch receipt URL (async)\n        Server->>DB: Store receipt URL\n        Server->>DB: 10. Custom Routines Processing (if enabled)\n    end'}),"\n",(0,r.jsx)(s.h3,{id:"four-ways-status-gets-updated",children:"Four Ways Status Gets Updated"}),"\n",(0,r.jsx)(s.p,{children:"The system has four mechanisms to detect payment completion. This redundancy ensures no payment is missed:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Method"}),(0,r.jsx)(s.th,{children:"How It Works"}),(0,r.jsx)(s.th,{children:"When It's Used"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Webhook"})}),(0,r.jsx)(s.td,{children:"Stripe sends a notification to our server"}),(0,r.jsx)(s.td,{children:"Primary method, fastest"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Polling"})}),(0,r.jsx)(s.td,{children:'Frontend asks server "is it done yet?"'}),(0,r.jsx)(s.td,{children:"Backup, after authenticated customer returns"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Public Polling"})}),(0,r.jsx)(s.td,{children:"Customer result page polls status"}),(0,r.jsx)(s.td,{children:"For ABM-initiated payments (unauthenticated)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.strong,{children:"Cron"})}),(0,r.jsx)(s.td,{children:"Background job checks every 5 minutes"}),(0,r.jsx)(s.td,{children:"Fallback, catches missed webhooks"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"LatestStatusUpdateSource"})," column shows which method updated the payment:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"webhook"})," - Updated by Stripe webhook"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"polling"})," - Updated when frontend checked status"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"public_polling"})," - Updated when customer result page checked status"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"cron"})," - Updated by background processor"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"5-what-gets-updated-and-when",children:"5. What Gets Updated and When"}),"\n",(0,r.jsx)(s.h3,{id:"phase-1-payment-creation",children:"Phase 1: Payment Creation"}),"\n",(0,r.jsx)(s.p,{children:'When a user clicks "Request Payment":'}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"created"})}),(0,r.jsx)(s.td,{children:"Initial state"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CustomerUniqueId"}),(0,r.jsx)(s.td,{children:"From selected customer"}),(0,r.jsx)(s.td,{children:"Links to Customers table"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CustomerCode"}),(0,r.jsx)(s.td,{children:"Customer's code"}),(0,r.jsxs)(s.td,{children:["e.g., ",(0,r.jsx)(s.code,{children:"000001"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"AmountInCents"}),(0,r.jsx)(s.td,{children:"Entered amount x 100"}),(0,r.jsx)(s.td,{children:"e.g., 25.50 becomes 2550"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Currency"}),(0,r.jsx)(s.td,{children:"From customer's CurrencyCode"}),(0,r.jsx)(s.td,{children:"Mapped to Stripe (EUR, USD, GBP, etc.)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"ReferenceText"}),(0,r.jsx)(s.td,{children:"User-entered reference"}),(0,r.jsxs)(s.td,{children:["e.g., ",(0,r.jsx)(s.code,{children:"Invoice #2024-001"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"IdempotencyKey"}),(0,r.jsx)(s.td,{children:"Auto-generated"}),(0,r.jsx)(s.td,{children:"Prevents duplicates"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CreatedByEmail"}),(0,r.jsx)(s.td,{children:"Logged-in user's email"}),(0,r.jsx)(s.td,{children:"Audit trail"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"SourceRole"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"abm"})," or ",(0,r.jsx)(s.code,{children:"external"})]}),(0,r.jsx)(s.td,{children:"Who initiated"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CreatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"}),(0,r.jsx)(s.td,{children:"Auto-set"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Currency Mapping"}),": Determined from customer's CurrencyCode field:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Code ",(0,r.jsx)(s.code,{children:"0"})," -> EUR, Code ",(0,r.jsx)(s.code,{children:"1"})," -> USD, Code ",(0,r.jsx)(s.code,{children:"44"})," -> GBP, Code ",(0,r.jsx)(s.code,{children:"81"})," -> JPY"]}),"\n",(0,r.jsx)(s.li,{children:"Unknown codes default to EUR"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"phase-2-session-created",children:"Phase 2: Session Created"}),"\n",(0,r.jsx)(s.p,{children:"After Stripe returns the checkout session:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pending"})}),(0,r.jsxs)(s.td,{children:["Changed from ",(0,r.jsx)(s.code,{children:"created"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"StripeSessionId"}),(0,r.jsx)(s.td,{children:"From Stripe"}),(0,r.jsxs)(s.td,{children:["e.g., ",(0,r.jsx)(s.code,{children:"cs_test_abc123"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"StripeSessionUrl"}),(0,r.jsx)(s.td,{children:"Checkout URL"}),(0,r.jsx)(s.td,{children:"Where customer goes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"ExpiresAt"}),(0,r.jsx)(s.td,{children:"Current time + 24 hours"}),(0,r.jsx)(s.td,{children:"Session timeout"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"UpdatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"}),(0,r.jsx)(s.td,{children:"Status change time"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"phase-3-payment-completed",children:"Phase 3: Payment Completed"}),"\n",(0,r.jsx)(s.p,{children:"When payment succeeds (via webhook, polling, or cron):"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"completed"})}),(0,r.jsxs)(s.td,{children:["Changed from ",(0,r.jsx)(s.code,{children:"pending"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CompletedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"}),(0,r.jsx)(s.td,{children:"When money was received"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"StripePaymentIntentId"}),(0,r.jsx)(s.td,{children:"From Stripe"}),(0,r.jsxs)(s.td,{children:["e.g., ",(0,r.jsx)(s.code,{children:"pi_xyz789"})]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"StripeEventId"}),(0,r.jsx)(s.td,{children:"Webhook event ID"}),(0,r.jsx)(s.td,{children:"For duplicate prevention"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"LatestStatusUpdateSource"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"webhook"}),"/",(0,r.jsx)(s.code,{children:"polling"}),"/",(0,r.jsx)(s.code,{children:"public_polling"}),"/",(0,r.jsx)(s.code,{children:"cron"})]}),(0,r.jsx)(s.td,{children:"What triggered update"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"UpdatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"}),(0,r.jsx)(s.td,{children:"Last update time"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"StripeReceiptUrl"}),(0,r.jsx)(s.td,{children:"Receipt link"}),(0,r.jsx)(s.td,{children:"Fetched asynchronously"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"phase-4-payment-failedexpiredcancelled",children:"Phase 4: Payment Failed/Expired/Cancelled"}),"\n",(0,r.jsx)(s.p,{children:"Depending on the outcome:"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"If Failed:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"failed"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"FailureReason"}),(0,r.jsx)(s.td,{children:"Error message from Stripe"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"UpdatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"If Expired:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"expired"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"UpdatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"If Cancelled:"})}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Status"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"cancelled"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"UpdatedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"phase-5-custom-routines-if-enabled",children:"Phase 5: Custom Routines (if enabled)"}),"\n",(0,r.jsx)(s.p,{children:"After payment completes, the custom routines processor runs configured SQL stored procedures:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Column"}),(0,r.jsx)(s.th,{children:"Value Set"}),(0,r.jsx)(s.th,{children:"Notes"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CustomRoutinesStatus"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"pending"})," -> ",(0,r.jsx)(s.code,{children:"completed"}),"/",(0,r.jsx)(s.code,{children:"error"})]}),(0,r.jsx)(s.td,{children:"Processing state"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CustomRoutinesProcessedAt"}),(0,r.jsx)(s.td,{children:"Current timestamp"}),(0,r.jsx)(s.td,{children:"When finished"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CustomRoutinesError"}),(0,r.jsx)(s.td,{children:"Error message (if failed)"}),(0,r.jsx)(s.td,{children:"Truncated to 1000 chars"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"6-the-happy-path",children:"6. The Happy Path"}),"\n",(0,r.jsx)(s.p,{children:"This is what a successful payment looks like in the database:"}),"\n",(0,r.jsx)(s.h3,{id:"timeline-example",children:"Timeline Example"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:'10:30:00  User clicks "Request Payment" for EUR 50.00\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: CREATED                                                     |\n| AmountInCents: 5000                                                 |\n| Currency: EUR                                                       |\n| ReferenceText: Invoice #2024-001                                    |\n| CreatedAt: 2025-01-09 10:30:00                                      |\n| CreatedByEmail: john@abm.com                                        |\n| SourceRole: abm                                                     |\n| IdempotencyKey: pay_CUST001_1736418600000                           |\n+---------------------------------------------------------------------+\n          |\n10:30:01  Stripe session created\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: PENDING  <-- Changed                                        |\n| StripeSessionId: cs_test_a1kXjgfZ8B9m...  <-- Added                |\n| StripeSessionUrl: https://checkout.stripe.com/...  <-- Added       |\n| ExpiresAt: 2025-01-10 10:30:01  <-- Added (24 hours later)         |\n| UpdatedAt: 2025-01-09 10:30:01  <-- Added                          |\n| ... (other fields unchanged)                                        |\n+---------------------------------------------------------------------+\n          |\n10:30:02  Customer redirected to Stripe checkout page\n          |\n          |  (Customer enters card details)\n          |\n10:32:15  Customer clicks "Pay" - Payment succeeds\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: COMPLETED  <-- Changed                                      |\n| CompletedAt: 2025-01-09 10:32:15  <-- Added                        |\n| StripePaymentIntentId: pi_3Qc8x9A...  <-- Added                    |\n| StripeEventId: evt_1Qc8xABC...  <-- Added                          |\n| LatestStatusUpdateSource: webhook  <-- Added                        |\n| UpdatedAt: 2025-01-09 10:32:15  <-- Updated                        |\n| StripeReceiptUrl: https://receipts.stripe.com/...  <-- Added       |\n| ... (other fields unchanged)                                        |\n+---------------------------------------------------------------------+\n'})}),"\n",(0,r.jsx)(s.h3,{id:"verifying-a-successful-payment",children:"Verifying a Successful Payment"}),"\n",(0,r.jsx)(s.p,{children:"A completed payment should have:"}),"\n",(0,r.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","Status = ",(0,r.jsx)(s.code,{children:"completed"})]}),"\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","CompletedAt has a value"]}),"\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","StripePaymentIntentId starts with ",(0,r.jsx)(s.code,{children:"pi_"})]}),"\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","StripeReceiptUrl is available (may take a few seconds)"]}),"\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","LatestStatusUpdateSource shows how it was updated"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"custom-routines-verification-if-enabled",children:"Custom Routines Verification (if enabled)"}),"\n",(0,r.jsxs)(s.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","CustomRoutinesStatus = ",(0,r.jsx)(s.code,{children:"completed"})," or ",(0,r.jsx)(s.code,{children:"skip"})]}),"\n",(0,r.jsxs)(s.li,{className:"task-list-item",children:[(0,r.jsx)(s.input,{type:"checkbox",disabled:!0})," ","If ",(0,r.jsx)(s.code,{children:"error"}),", check CustomRoutinesError"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"7-custom-routines-processing",children:"7. Custom Routines Processing"}),"\n",(0,r.jsx)(s.h3,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(s.p,{children:"Custom routines allow automatic execution of SQL stored procedures after a payment completes. This is useful for triggering business logic like updating invoice statuses, sending notifications, or syncing with external systems."}),"\n",(0,r.jsx)(s.h3,{id:"status-flow",children:"Status Flow"}),"\n",(0,r.jsx)(s.mermaid,{value:"flowchart TD\n    A[Payment Completed] --\x3e B{Custom Routines<br/>Enabled?}\n    B --\x3e|No| C[Status: skip]\n    B --\x3e|Yes| D[Status: pending]\n    D --\x3e E[Processor runs<br/>every 60s]\n    E --\x3e F{Procedures<br/>succeed?}\n    F --\x3e|Yes| G[Status: completed]\n    F --\x3e|No| H[Status: error]"}),"\n",(0,r.jsx)(s.h3,{id:"key-support-notes",children:"Key Support Notes"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"No automatic retry"}),": If a custom routine fails, it stays in ",(0,r.jsx)(s.code,{children:"error"})," status. Manual intervention is required."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Payment still successful"}),": Custom routines failing does NOT affect the payment status. The payment is still ",(0,r.jsx)(s.code,{children:"completed"})," even if routines fail."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Processing interval"}),": Configurable in Stripe App Configuration (",(0,r.jsx)(s.code,{children:"customRoutines.processIntervalMs"}),"); default is 60 seconds."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Error messages"}),": Check ",(0,r.jsx)(s.code,{children:"CustomRoutinesError"})," for the specific error. Messages are truncated to 1000 characters."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Symptom"}),(0,r.jsx)(s.th,{children:"Likely Cause"}),(0,r.jsx)(s.th,{children:"Resolution"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:["Status stuck on ",(0,r.jsx)(s.code,{children:"pending"})]}),(0,r.jsx)(s.td,{children:"Processor not running"}),(0,r.jsx)(s.td,{children:"Check server logs for processor errors"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:["Status = ",(0,r.jsx)(s.code,{children:"error"})]}),(0,r.jsx)(s.td,{children:"Stored procedure failed"}),(0,r.jsx)(s.td,{children:"Check CustomRoutinesError, fix procedure"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsxs)(s.td,{children:["Status = ",(0,r.jsx)(s.code,{children:"skip"})]}),(0,r.jsx)(s.td,{children:"Feature disabled"}),(0,r.jsx)(s.td,{children:"Normal - no action needed"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"8-abm-vs-external-user-flows",children:"8. ABM vs External User Flows"}),"\n",(0,r.jsx)(s.h3,{id:"overview-1",children:"Overview"}),"\n",(0,r.jsx)(s.p,{children:"Payments can be initiated by two types of users, with different flows:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Aspect"}),(0,r.jsx)(s.th,{children:"ABM Users"}),(0,r.jsx)(s.th,{children:"External Users"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Who"}),(0,r.jsx)(s.td,{children:"Internal staff"}),(0,r.jsx)(s.td,{children:"Customers with portal access"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"SourceRole"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"abm"})}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"external"})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Success URL"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"/payments/customer-result"})," (public)"]}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"/payments/result"})," (authenticated)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"QR Code"}),(0,r.jsx)(s.td,{children:"Yes - share with customer"}),(0,r.jsx)(s.td,{children:"No - pays directly"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"why-different-success-urls",children:"Why Different Success URLs?"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"ABM Users"})," initiate payments on behalf of customers. The customer receives a QR code or link to pay. When they complete payment, they land on a public result page (",(0,r.jsx)(s.code,{children:"/payments/customer-result"}),") that doesn't require login."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"External Users"})," are customers logged into the portal who pay their own invoices. After payment, they return to an authenticated result page (",(0,r.jsx)(s.code,{children:"/payments/result"}),") within their portal session."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Important:"})," The public customer result page does ",(0,r.jsx)(s.strong,{children:"not"})," mark a payment as ",(0,r.jsx)(s.code,{children:"cancelled"}),". It only polls status and shows the result. If the customer cancels the Stripe checkout, the payment stays ",(0,r.jsx)(s.code,{children:"pending"})," until it expires or completes. Only the authenticated result flow (",(0,r.jsx)(s.code,{children:"/payments/result"}),") calls the cancel API to set ",(0,r.jsx)(s.code,{children:"cancelled"}),"."]}),"\n",(0,r.jsx)(s.h3,{id:"identifying-payment-source",children:"Identifying Payment Source"}),"\n",(0,r.jsxs)(s.p,{children:["Check the ",(0,r.jsx)(s.code,{children:"SourceRole"})," column:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"abm"})," = Created by internal ABM staff"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"external"})," = Created by external customer directly"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"support-scenarios",children:"Support Scenarios"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"ABM-initiated payment issues:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Customer says they paid but record shows ",(0,r.jsx)(s.code,{children:"pending"})," -> Check if webhook was received, wait for cron"]}),"\n",(0,r.jsx)(s.li,{children:"Customer can't access QR code -> Resend the payment link from the payment details screen"}),"\n",(0,r.jsxs)(s.li,{children:["Status shows ",(0,r.jsx)(s.code,{children:"completed"})," but customer didn't see success page -> Payment succeeded, their browser may have closed"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"External-initiated payment issues:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Customer logged out mid-payment -> Payment still processes, check status via SourceRole = ",(0,r.jsx)(s.code,{children:"external"})]}),"\n",(0,r.jsx)(s.li,{children:"Customer wants receipt -> Check StripeReceiptUrl or direct them to check email"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"9-edge-cases-and-how-the-system-handles-them",children:"9. Edge Cases and How the System Handles Them"}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-1-customers-browser-crashes-during-payment",children:"Edge Case 1: Customer's Browser Crashes During Payment"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Customer enters card details, clicks Pay, but their browser crashes before seeing the result."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"The payment may have succeeded on Stripe's side"}),"\n",(0,r.jsx)(s.li,{children:"Customer doesn't see the success page"}),"\n",(0,r.jsxs)(s.li,{children:["Our webhook still receives the ",(0,r.jsx)(s.code,{children:"checkout.session.completed"})," event"]}),"\n",(0,r.jsxs)(s.li,{children:["Payment status is updated to ",(0,r.jsx)(s.code,{children:"completed"})," via webhook"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," Check if Status = ",(0,r.jsx)(s.code,{children:"completed"})," and LatestStatusUpdateSource = ",(0,r.jsx)(s.code,{children:"webhook"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Resolution:"})," Payment was successful. Customer can view receipt via StripeReceiptUrl."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-2-webhook-fails-to-arrive",children:"Edge Case 2: Webhook Fails to Arrive"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Network issues prevent Stripe's webhook from reaching our server."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Payment succeeds on Stripe"}),"\n",(0,r.jsx)(s.li,{children:"Webhook doesn't arrive (or fails to process)"}),"\n",(0,r.jsxs)(s.li,{children:["Status remains ",(0,r.jsx)(s.code,{children:"pending"})]}),"\n",(0,r.jsx)(s.li,{children:"Background cron job runs every 5 minutes"}),"\n",(0,r.jsx)(s.li,{children:"Cron checks Stripe for actual payment status"}),"\n",(0,r.jsxs)(s.li,{children:["Status updated to ",(0,r.jsx)(s.code,{children:"completed"})," by cron"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," LatestStatusUpdateSource = ",(0,r.jsx)(s.code,{children:"cron"})," instead of ",(0,r.jsx)(s.code,{children:"webhook"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Timeframe:"})," Payment will be detected within 5 minutes max."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-3-customer-abandons-checkout",children:"Edge Case 3: Customer Abandons Checkout"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Customer is redirected to Stripe but never enters card details."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Status stays ",(0,r.jsx)(s.code,{children:"pending"})]}),"\n",(0,r.jsx)(s.li,{children:"After 24 hours, Stripe expires the session"}),"\n",(0,r.jsxs)(s.li,{children:["Stripe sends ",(0,r.jsx)(s.code,{children:"checkout.session.expired"})," webhook"]}),"\n",(0,r.jsxs)(s.li,{children:["Status updated to ",(0,r.jsx)(s.code,{children:"expired"})]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," Status = ",(0,r.jsx)(s.code,{children:"expired"})," and CompletedAt is NULL."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Resolution:"})," Customer needs to initiate a new payment."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-3b-customer-clicks-cancel-on-stripe-checkout",children:'Edge Case 3b: Customer Clicks "Cancel" on Stripe Checkout'}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Customer clicks the cancel link on the Stripe checkout page."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["For ",(0,r.jsx)(s.strong,{children:"external users"})," (authenticated flow), the result page calls the cancel API"]}),"\n",(0,r.jsxs)(s.li,{children:["Status updates to ",(0,r.jsx)(s.code,{children:"cancelled"})]}),"\n",(0,r.jsxs)(s.li,{children:["For ",(0,r.jsx)(s.strong,{children:"ABM public payments"}),", the result page is public and does ",(0,r.jsx)(s.strong,{children:"not"})," cancel"]}),"\n",(0,r.jsxs)(s.li,{children:["Status stays ",(0,r.jsx)(s.code,{children:"pending"})," until Stripe expires it or a webhook marks it ",(0,r.jsx)(s.code,{children:"completed"})]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," Check ",(0,r.jsx)(s.code,{children:"LatestStatusUpdateSource"}),":"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"polling"})," for authenticated cancel"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"public_polling"})," for public status checks (no cancellation)"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-4-card-declined",children:"Edge Case 4: Card Declined"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Customer's card has insufficient funds or is blocked."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Customer enters card details and clicks Pay"}),"\n",(0,r.jsx)(s.li,{children:"Bank declines the card"}),"\n",(0,r.jsx)(s.li,{children:"Stripe shows error to customer"}),"\n",(0,r.jsx)(s.li,{children:"Customer can try again with different card"}),"\n",(0,r.jsx)(s.li,{children:"If they give up, session eventually expires"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," If they eventually fail out:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Status = ",(0,r.jsx)(s.code,{children:"failed"})," or ",(0,r.jsx)(s.code,{children:"expired"})]}),"\n",(0,r.jsx)(s.li,{children:"FailureReason may contain error message"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Resolution:"})," Customer should try with a different card or contact their bank."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-5-network-retry-creates-duplicate-request",children:"Edge Case 5: Network Retry Creates Duplicate Request"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"}),' User clicks "Request Payment" but network is slow. They click again.']}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"First request creates payment with IdempotencyKey"}),"\n",(0,r.jsx)(s.li,{children:"Second request arrives with same IdempotencyKey"}),"\n",(0,r.jsx)(s.li,{children:"System detects duplicate via IdempotencyKey"}),"\n",(0,r.jsx)(s.li,{children:"Returns existing StripeSessionUrl instead of creating new payment"}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," Only one record exists in StripePayments for that IdempotencyKey."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Protection:"})," The IdempotencyKey prevents duplicate charges."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-6-payment-stuck-in-created-status",children:"Edge Case 6: Payment Stuck in CREATED Status"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," Payment was created but Stripe session was never set up."]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"What happens:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Record created with Status = ",(0,r.jsx)(s.code,{children:"created"})]}),"\n",(0,r.jsx)(s.li,{children:"Error occurred calling Stripe API"}),"\n",(0,r.jsxs)(s.li,{children:["Status never moved to ",(0,r.jsx)(s.code,{children:"pending"})]}),"\n",(0,r.jsx)(s.li,{children:"StripeSessionId is NULL"}),"\n",(0,r.jsxs)(s.li,{children:["After 5 minutes, cron marks it as ",(0,r.jsx)(s.code,{children:"failed"})]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"How to verify:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Status = ",(0,r.jsx)(s.code,{children:"created"})," (if recent) or ",(0,r.jsx)(s.code,{children:"failed"})," (if >5 min old)"]}),"\n",(0,r.jsx)(s.li,{children:"StripeSessionId is NULL or empty"}),"\n",(0,r.jsx)(s.li,{children:'FailureReason = "Session creation timed out"'}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Resolution:"})," User should try creating a new payment."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h3,{id:"edge-case-7-amount-validation-failures",children:"Edge Case 7: Amount Validation Failures"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Scenario:"})," User tries to process an invalid amount."]}),"\n",(0,r.jsxs)(s.p,{children:["Default limits apply unless overridden in Stripe App Configuration (",(0,r.jsx)(s.code,{children:"stripe.minAmount"})," / ",(0,r.jsx)(s.code,{children:"stripe.maxAmount"}),")."]}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Condition"}),(0,r.jsx)(s.th,{children:"Result"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Amount < configured minimum (default 0.50)"}),(0,r.jsx)(s.td,{children:'Rejected: "Amount must be at least [minAmount]"'})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Amount > configured maximum (default 50,000)"}),(0,r.jsx)(s.td,{children:'Rejected: "Amount cannot exceed [maxAmount]"'})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Amount is negative"}),(0,r.jsx)(s.td,{children:"Rejected before payment created"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Amount is 0"}),(0,r.jsx)(s.td,{children:"Rejected before payment created"})]})]})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How to verify:"})," No record created in StripePayments if rejected early."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"10-troubleshooting-guide",children:"10. Troubleshooting Guide"}),"\n",(0,r.jsx)(s.h3,{id:"problem-payment-shows-pending-but-customer-says-they-paid",children:"Problem: Payment Shows PENDING But Customer Says They Paid"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check these in order:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Verify in Stripe Dashboard"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Go to dashboard.stripe.com"}),"\n",(0,r.jsx)(s.li,{children:"Search for the customer or session ID"}),"\n",(0,r.jsx)(s.li,{children:'Check if payment shows as "Succeeded" in Stripe'}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:'If Stripe shows "Succeeded" but our system shows PENDING:'})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Webhook may have failed"}),"\n",(0,r.jsx)(s.li,{children:"Wait up to 5 minutes for cron to catch it"}),"\n",(0,r.jsx)(s.li,{children:"Or manually trigger a status check by refreshing the payment page"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check LatestStatusUpdateSource:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"NULL = webhook hasn't processed yet"}),"\n",(0,r.jsx)(s.li,{children:"If it shows a source but status is still pending, there may be a bug"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"problem-payment-failed-but-no-failurereason",children:"Problem: Payment Failed But No FailureReason"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Possible causes:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Session expired (no failure, just timeout)"}),"\n",(0,r.jsx)(s.li,{children:"Customer cancelled (clicked cancel button)"}),"\n",(0,r.jsx)(s.li,{children:"Webhook for failure event wasn't configured"}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Look at Status: ",(0,r.jsx)(s.code,{children:"expired"})," or ",(0,r.jsx)(s.code,{children:"cancelled"})," don't have failure reasons"]}),"\n",(0,r.jsxs)(s.li,{children:["Only ",(0,r.jsx)(s.code,{children:"failed"})," status should have FailureReason"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"problem-customer-cant-find-their-receipt",children:"Problem: Customer Can't Find Their Receipt"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"Is StripeReceiptUrl populated?"}),"\n",(0,r.jsx)(s.li,{children:"Receipt is fetched asynchronously, may take a few seconds"}),"\n",(0,r.jsx)(s.li,{children:"If NULL after 24 hours, receipt fetch may have failed"}),"\n",(0,r.jsx)(s.li,{children:"Customer can also find receipt in their email (if email receipts enabled in Stripe)"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"problem-duplicate-payments-in-database",children:"Problem: Duplicate Payments in Database"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"This shouldn't happen, but if it does:"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Check if they have different IdempotencyKeys (different payment attempts)"}),"\n",(0,r.jsx)(s.li,{children:"Check if they have the same StripeSessionId (indicates a bug)"}),"\n",(0,r.jsxs)(s.li,{children:["Only one should be ",(0,r.jsx)(s.code,{children:"completed"})," - the other should be ",(0,r.jsx)(s.code,{children:"expired"})," or ",(0,r.jsx)(s.code,{children:"failed"})]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"problem-payment-shows-amount-doesnt-match-what-customer-paid",children:"Problem: Payment Shows Amount Doesn't Match What Customer Paid"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Check:"})}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"AmountInCents is in cents, not currency units"}),"\n",(0,r.jsx)(s.li,{children:"Divide by 100 to get the actual amount"}),"\n",(0,r.jsx)(s.li,{children:"Example: 2550 = EUR 25.50"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"11-quick-reference",children:"11. Quick Reference"}),"\n",(0,r.jsx)(s.h3,{id:"status-at-a-glance",children:"Status at a Glance"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Status"}),(0,r.jsx)(s.th,{children:"Color"}),(0,r.jsx)(s.th,{children:"Next Step"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CREATED"}),(0,r.jsx)(s.td,{children:"Blue"}),(0,r.jsx)(s.td,{children:"Wait - session being created"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"PENDING"}),(0,r.jsx)(s.td,{children:"Yellow"}),(0,r.jsx)(s.td,{children:"Customer is on checkout page"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"COMPLETED"}),(0,r.jsx)(s.td,{children:"Green"}),(0,r.jsx)(s.td,{children:"Done - money received"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"FAILED"}),(0,r.jsx)(s.td,{children:"Red"}),(0,r.jsx)(s.td,{children:"Payment rejected - try again"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"CANCELLED"}),(0,r.jsx)(s.td,{children:"Red"}),(0,r.jsx)(s.td,{children:"Customer cancelled - try again"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"EXPIRED"}),(0,r.jsx)(s.td,{children:"Grey"}),(0,r.jsx)(s.td,{children:"Took too long - try again"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"key-columns-for-troubleshooting",children:"Key Columns for Troubleshooting"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"What You Need"}),(0,r.jsx)(s.th,{children:"Column to Check"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Current status"}),(0,r.jsx)(s.td,{children:"Status"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"When payment completed"}),(0,r.jsx)(s.td,{children:"CompletedAt"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"How status was updated"}),(0,r.jsx)(s.td,{children:"LatestStatusUpdateSource"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Why it failed"}),(0,r.jsx)(s.td,{children:"FailureReason"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Receipt link"}),(0,r.jsx)(s.td,{children:"StripeReceiptUrl"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Who initiated payment"}),(0,r.jsx)(s.td,{children:"CreatedByEmail, SourceRole"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Payment amount"}),(0,r.jsx)(s.td,{children:"AmountInCents / 100"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Post-payment processing"}),(0,r.jsx)(s.td,{children:"CustomRoutinesStatus"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Why custom routines failed"}),(0,r.jsx)(s.td,{children:"CustomRoutinesError"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"custom-routines-status-at-a-glance",children:"Custom Routines Status at a Glance"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Status"}),(0,r.jsx)(s.th,{children:"Meaning"}),(0,r.jsx)(s.th,{children:"Action"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"skip"})}),(0,r.jsx)(s.td,{children:"Feature disabled"}),(0,r.jsx)(s.td,{children:"None"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pending"})}),(0,r.jsx)(s.td,{children:"Waiting for processor"}),(0,r.jsx)(s.td,{children:"Wait (default 60s)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"completed"})}),(0,r.jsx)(s.td,{children:"All procedures ran"}),(0,r.jsx)(s.td,{children:"None"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"error"})}),(0,r.jsx)(s.td,{children:"Procedure failed"}),(0,r.jsx)(s.td,{children:"Check CustomRoutinesError"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"id-prefixes",children:"ID Prefixes"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Prefix"}),(0,r.jsx)(s.th,{children:"Meaning"}),(0,r.jsx)(s.th,{children:"Example"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"cs_"})}),(0,r.jsx)(s.td,{children:"Checkout Session ID"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"cs_test_a1b2c3..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pi_"})}),(0,r.jsx)(s.td,{children:"Payment Intent ID"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"pi_3abc123..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"evt_"})}),(0,r.jsx)(s.td,{children:"Stripe Event ID"}),(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"evt_1xyz789..."})})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"whsec_"})}),(0,r.jsx)(s.td,{children:"Webhook Secret"}),(0,r.jsx)(s.td,{children:"(config only)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"sk_test_"})}),(0,r.jsx)(s.td,{children:"Test API Key"}),(0,r.jsx)(s.td,{children:"(config only)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"sk_live_"})}),(0,r.jsx)(s.td,{children:"Live API Key"}),(0,r.jsx)(s.td,{children:"(config only)"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"important-timeframes",children:"Important Timeframes"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Event"}),(0,r.jsx)(s.th,{children:"Timeframe"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Checkout session expiry"}),(0,r.jsx)(s.td,{children:"24 hours after creation"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:'Stuck "created" timeout'}),(0,r.jsx)(s.td,{children:"5 minutes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Background cron check"}),(0,r.jsx)(s.td,{children:"Every 5 minutes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"Custom routine processing"}),(0,r.jsx)(s.td,{children:"Configurable (default 60s)"})]})]})]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsx)(s.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"./user-guide",children:"User Guide"})," - End user guide for making payments"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"./configuration",children:"Configuration Guide"})," - Server configuration setup"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"./production-checklist",children:"Production Checklist"})," - Going live checklist"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.a,{href:"./developer-access",children:"Developer Access Guide"})," - Developer access for clients"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Developer Documentation"})," (server/payments/):"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["Currency mapping: ",(0,r.jsx)(s.code,{children:"currencyMapping.js"})]}),"\n"]})]})}function a(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);