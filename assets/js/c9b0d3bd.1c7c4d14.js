"use strict";(globalThis.webpackChunkabm_web_portal_docs=globalThis.webpackChunkabm_web_portal_docs||[]).push([[7340],{7033(e,t,n){n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"stripe-integration/technical-reference/payment-workflow","title":"How Does the Payment Workflow Work?","description":"Complete payment flow diagram showing what happens at each phase, what database columns get updated, and the four ways payment status can be updated.","source":"@site/versioned_docs/version-1.2/stripe-integration/technical-reference/payment-workflow.md","sourceDirName":"stripe-integration/technical-reference","slug":"/stripe-integration/technical-reference/payment-workflow","permalink":"/knowledgebase/stripe-integration/technical-reference/payment-workflow","draft":false,"unlisted":false,"tags":[],"version":"1.2","sidebarPosition":3,"frontMatter":{"title":"How Does the Payment Workflow Work?","sidebar_position":3,"description":"Complete payment flow diagram showing what happens at each phase, what database columns get updated, and the four ways payment status can be updated.","keywords":["workflow","payment","sequence","diagram","webhook","polling","cron"]},"sidebar":"docsSidebar","previous":{"title":"What Do the Payment Statuses Mean?","permalink":"/knowledgebase/stripe-integration/technical-reference/payment-status-lifecycle"},"next":{"title":"How Do Custom Routines Work?","permalink":"/knowledgebase/stripe-integration/technical-reference/custom-routines"}}');var d=n(4848),r=n(8453);const i={title:"How Does the Payment Workflow Work?",sidebar_position:3,description:"Complete payment flow diagram showing what happens at each phase, what database columns get updated, and the four ways payment status can be updated.",keywords:["workflow","payment","sequence","diagram","webhook","polling","cron"]},c="How Does the Payment Workflow Work?",a={},l=[{value:"Complete Payment Flow",id:"complete-payment-flow",level:2},{value:"How Does Payment Status Get Updated?",id:"how-does-payment-status-get-updated",level:2},{value:"What Gets Updated During Payment Creation?",id:"what-gets-updated-during-payment-creation",level:2},{value:"What Gets Updated When Session Is Created?",id:"what-gets-updated-when-session-is-created",level:2},{value:"What Gets Updated When Payment Completes?",id:"what-gets-updated-when-payment-completes",level:2},{value:"What Gets Updated When Payment Fails?",id:"what-gets-updated-when-payment-fails",level:2},{value:"What Does a Successful Payment Look Like?",id:"what-does-a-successful-payment-look-like",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function o(e){const t={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(t.header,{children:(0,d.jsx)(t.h1,{id:"how-does-the-payment-workflow-work",children:"How Does the Payment Workflow Work?"})}),"\n",(0,d.jsx)(t.p,{children:"This guide explains the complete payment flow from creation to completion, including what gets updated in the database at each phase."}),"\n",(0,d.jsx)(t.h2,{id:"complete-payment-flow",children:"Complete Payment Flow"}),"\n",(0,d.jsx)(t.mermaid,{value:'sequenceDiagram\n    participant Portal as ABM Portal\n    participant Server as Our Server\n    participant Stripe\n    participant DB as StripePayments DB\n\n    rect rgb(240, 248, 255)\n        Note over Portal,DB: Payment Creation Phase\n        Portal->>Server: 1. Click "Request Payment"\n        Server->>DB: 2. Create payment record (Status: CREATED)\n        Server->>Stripe: 3. Create checkout session\n        Stripe--\x3e>Server: Session URL returned\n        Server->>DB: 4. Update record (Status: PENDING, store session URL)\n        Server--\x3e>Portal: 5. Return checkout URL\n    end\n\n    rect rgb(255, 248, 240)\n        Note over Portal,DB: Customer Checkout Phase\n        Portal->>Stripe: 6. Redirect customer to Stripe\n        Note over Stripe: Customer enters card details<br/>and clicks "Pay"\n        Stripe->>Stripe: Process payment\n    end\n\n    rect rgb(240, 255, 240)\n        Note over Portal,DB: Status Update Phase\n        alt Webhook (Primary)\n            Stripe->>Server: 7a. Send webhook event\n        else Polling (Backup)\n            Portal->>Server: 7b. Frontend checks status\n        else Cron (Fallback)\n            Server->>Stripe: 7c. Background job checks\n        end\n        Server->>DB: 8. Update status to COMPLETED\n        Server->>Stripe: 9. Fetch receipt URL (async)\n        Server->>DB: Store receipt URL\n        Server->>DB: 10. Custom Routines Processing (if enabled)\n    end'}),"\n",(0,d.jsx)(t.h2,{id:"how-does-payment-status-get-updated",children:"How Does Payment Status Get Updated?"}),"\n",(0,d.jsx)(t.p,{children:"The system has four mechanisms to detect payment completion. This redundancy ensures no payment is missed:"}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Method"}),(0,d.jsx)(t.th,{children:"How It Works"}),(0,d.jsx)(t.th,{children:"When It's Used"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.strong,{children:"Webhook"})}),(0,d.jsx)(t.td,{children:"Stripe sends a notification to our server"}),(0,d.jsx)(t.td,{children:"Primary method, fastest"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.strong,{children:"Polling"})}),(0,d.jsx)(t.td,{children:'Frontend asks server "is it done yet?"'}),(0,d.jsx)(t.td,{children:"Backup, after authenticated customer returns"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.strong,{children:"Public Polling"})}),(0,d.jsx)(t.td,{children:"Customer result page polls status"}),(0,d.jsx)(t.td,{children:"For ABM-initiated payments (unauthenticated)"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:(0,d.jsx)(t.strong,{children:"Cron"})}),(0,d.jsx)(t.td,{children:"Background job checks every 5 minutes"}),(0,d.jsx)(t.td,{children:"Fallback, catches missed webhooks"})]})]})]}),"\n",(0,d.jsxs)(t.p,{children:["The ",(0,d.jsx)(t.code,{children:"LatestStatusUpdateSource"})," column shows which method updated the payment:"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"webhook"})," - Updated by Stripe webhook"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"polling"})," - Updated when frontend checked status"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"public_polling"})," - Updated when customer result page checked status"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.code,{children:"cron"})," - Updated by background processor"]}),"\n"]}),"\n",(0,d.jsx)(t.h2,{id:"what-gets-updated-during-payment-creation",children:"What Gets Updated During Payment Creation?"}),"\n",(0,d.jsx)(t.p,{children:'When a user clicks "Request Payment":'}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"}),(0,d.jsx)(t.th,{children:"Notes"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"created"})}),(0,d.jsx)(t.td,{children:"Initial state"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"CustomerUniqueId"}),(0,d.jsx)(t.td,{children:"From selected customer"}),(0,d.jsx)(t.td,{children:"Links to Customers table"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"CustomerCode"}),(0,d.jsx)(t.td,{children:"Customer's code"}),(0,d.jsxs)(t.td,{children:["e.g., ",(0,d.jsx)(t.code,{children:"000001"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"AmountInCents"}),(0,d.jsx)(t.td,{children:"Entered amount x 100"}),(0,d.jsx)(t.td,{children:"e.g., 25.50 becomes 2550"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Currency"}),(0,d.jsx)(t.td,{children:"From customer's CurrencyCode"}),(0,d.jsx)(t.td,{children:"Mapped to Stripe (EUR, USD, GBP, etc.)"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"ReferenceText"}),(0,d.jsx)(t.td,{children:"User-entered reference"}),(0,d.jsxs)(t.td,{children:["e.g., ",(0,d.jsx)(t.code,{children:"Invoice #2024-001"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"IdempotencyKey"}),(0,d.jsx)(t.td,{children:"Auto-generated"}),(0,d.jsx)(t.td,{children:"Prevents duplicates"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"CreatedByEmail"}),(0,d.jsx)(t.td,{children:"Logged-in user's email"}),(0,d.jsx)(t.td,{children:"Audit trail"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"SourceRole"}),(0,d.jsxs)(t.td,{children:[(0,d.jsx)(t.code,{children:"abm"})," or ",(0,d.jsx)(t.code,{children:"external"})]}),(0,d.jsx)(t.td,{children:"Who initiated"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"CreatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"}),(0,d.jsx)(t.td,{children:"Auto-set"})]})]})]}),"\n",(0,d.jsxs)(t.admonition,{title:"Currency Mapping",type:"note",children:[(0,d.jsx)(t.p,{children:"Determined from customer's CurrencyCode field:"}),(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["Code ",(0,d.jsx)(t.code,{children:"0"})," -> EUR, Code ",(0,d.jsx)(t.code,{children:"1"})," -> USD, Code ",(0,d.jsx)(t.code,{children:"44"})," -> GBP, Code ",(0,d.jsx)(t.code,{children:"81"})," -> JPY"]}),"\n",(0,d.jsx)(t.li,{children:"Unknown codes default to EUR"}),"\n"]})]}),"\n",(0,d.jsx)(t.h2,{id:"what-gets-updated-when-session-is-created",children:"What Gets Updated When Session Is Created?"}),"\n",(0,d.jsx)(t.p,{children:"After Stripe returns the checkout session:"}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"}),(0,d.jsx)(t.th,{children:"Notes"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"pending"})}),(0,d.jsxs)(t.td,{children:["Changed from ",(0,d.jsx)(t.code,{children:"created"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"StripeSessionId"}),(0,d.jsx)(t.td,{children:"From Stripe"}),(0,d.jsxs)(t.td,{children:["e.g., ",(0,d.jsx)(t.code,{children:"cs_test_abc123"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"StripeSessionUrl"}),(0,d.jsx)(t.td,{children:"Checkout URL"}),(0,d.jsx)(t.td,{children:"Where customer goes"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"ExpiresAt"}),(0,d.jsx)(t.td,{children:"Current time + 24 hours"}),(0,d.jsx)(t.td,{children:"Session timeout"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"UpdatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"}),(0,d.jsx)(t.td,{children:"Status change time"})]})]})]}),"\n",(0,d.jsx)(t.h2,{id:"what-gets-updated-when-payment-completes",children:"What Gets Updated When Payment Completes?"}),"\n",(0,d.jsx)(t.p,{children:"When payment succeeds (via webhook, polling, or cron):"}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"}),(0,d.jsx)(t.th,{children:"Notes"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"completed"})}),(0,d.jsxs)(t.td,{children:["Changed from ",(0,d.jsx)(t.code,{children:"pending"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"CompletedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"}),(0,d.jsx)(t.td,{children:"When money was received"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"StripePaymentIntentId"}),(0,d.jsx)(t.td,{children:"From Stripe"}),(0,d.jsxs)(t.td,{children:["e.g., ",(0,d.jsx)(t.code,{children:"pi_xyz789"})]})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"StripeEventId"}),(0,d.jsx)(t.td,{children:"Webhook event ID"}),(0,d.jsx)(t.td,{children:"For duplicate prevention"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"LatestStatusUpdateSource"}),(0,d.jsxs)(t.td,{children:[(0,d.jsx)(t.code,{children:"webhook"}),"/",(0,d.jsx)(t.code,{children:"polling"}),"/",(0,d.jsx)(t.code,{children:"public_polling"}),"/",(0,d.jsx)(t.code,{children:"cron"})]}),(0,d.jsx)(t.td,{children:"What triggered update"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"UpdatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"}),(0,d.jsx)(t.td,{children:"Last update time"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"StripeReceiptUrl"}),(0,d.jsx)(t.td,{children:"Receipt link"}),(0,d.jsx)(t.td,{children:"Fetched asynchronously"})]})]})]}),"\n",(0,d.jsx)(t.h2,{id:"what-gets-updated-when-payment-fails",children:"What Gets Updated When Payment Fails?"}),"\n",(0,d.jsx)(t.p,{children:(0,d.jsx)(t.strong,{children:"If Failed:"})}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"failed"})})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"FailureReason"}),(0,d.jsx)(t.td,{children:"Error message from Stripe"})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"UpdatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"})]})]})]}),"\n",(0,d.jsx)(t.p,{children:(0,d.jsx)(t.strong,{children:"If Expired:"})}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"expired"})})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"UpdatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"})]})]})]}),"\n",(0,d.jsx)(t.p,{children:(0,d.jsx)(t.strong,{children:"If Cancelled:"})}),"\n",(0,d.jsxs)(t.table,{children:[(0,d.jsx)(t.thead,{children:(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.th,{children:"Column"}),(0,d.jsx)(t.th,{children:"Value Set"})]})}),(0,d.jsxs)(t.tbody,{children:[(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"Status"}),(0,d.jsx)(t.td,{children:(0,d.jsx)(t.code,{children:"cancelled"})})]}),(0,d.jsxs)(t.tr,{children:[(0,d.jsx)(t.td,{children:"UpdatedAt"}),(0,d.jsx)(t.td,{children:"Current timestamp"})]})]})]}),"\n",(0,d.jsx)(t.h2,{id:"what-does-a-successful-payment-look-like",children:"What Does a Successful Payment Look Like?"}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{children:'10:30:00  User clicks "Request Payment" for EUR 50.00\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: CREATED                                                     |\n| AmountInCents: 5000                                                 |\n| Currency: EUR                                                       |\n| ReferenceText: Invoice #2024-001                                    |\n| CreatedAt: 2025-01-09 10:30:00                                      |\n| CreatedByEmail: john@abm.com                                        |\n| SourceRole: abm                                                     |\n| IdempotencyKey: pay_CUST001_1736418600000                           |\n+---------------------------------------------------------------------+\n          |\n10:30:01  Stripe session created\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: PENDING  <-- Changed                                        |\n| StripeSessionId: cs_test_a1kXjgfZ8B9m...  <-- Added                |\n| StripeSessionUrl: https://checkout.stripe.com/...  <-- Added       |\n| ExpiresAt: 2025-01-10 10:30:01  <-- Added (24 hours later)         |\n| UpdatedAt: 2025-01-09 10:30:01  <-- Added                          |\n| ... (other fields unchanged)                                        |\n+---------------------------------------------------------------------+\n          |\n10:30:02  Customer redirected to Stripe checkout page\n          |\n          |  (Customer enters card details)\n          |\n10:32:15  Customer clicks "Pay" - Payment succeeds\n          |\n          v\n+---------------------------------------------------------------------+\n| PaymentId: 1                                                        |\n| Status: COMPLETED  <-- Changed                                      |\n| CompletedAt: 2025-01-09 10:32:15  <-- Added                        |\n| StripePaymentIntentId: pi_3Qc8x9A...  <-- Added                    |\n| StripeEventId: evt_1Qc8xABC...  <-- Added                          |\n| LatestStatusUpdateSource: webhook  <-- Added                        |\n| UpdatedAt: 2025-01-09 10:32:15  <-- Updated                        |\n| StripeReceiptUrl: https://receipts.stripe.com/...  <-- Added       |\n| ... (other fields unchanged)                                        |\n+---------------------------------------------------------------------+\n'})}),"\n",(0,d.jsx)(t.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.a,{href:"./database-schema",children:"What Is the StripePayments Database Table?"})," - Column reference"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.a,{href:"./payment-status-lifecycle",children:"What Do the Payment Statuses Mean?"})," - Status definitions"]}),"\n",(0,d.jsxs)(t.li,{children:[(0,d.jsx)(t.a,{href:"./custom-routines",children:"Custom Routines Processing"})," - Post-payment automation"]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,d.jsx)(t,{...e,children:(0,d.jsx)(o,{...e})}):o(e)}},8453(e,t,n){n.d(t,{R:()=>i,x:()=>c});var s=n(6540);const d={},r=s.createContext(d);function i(e){const t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:i(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);